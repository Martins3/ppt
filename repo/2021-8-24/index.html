<html>

<head>
  <link rel="stylesheet" href="../../reveal.js/dist/reveal.css">
  <link rel="stylesheet" href="../../reveal.js/dist/theme/sky.css">
</head>

<body>
  <div class="reveal">
    <div class="slides">

      <section>
        <h2>动机</h2>
        <p>Captive</p>
        </p>
      </section>

      <section>
        <h2>动机</h2>
        <p>Ramooflax</p>
        <img class="r-stretch" src="../../images/ramooflax.png">
        <p style="font-size:0.5em">
          ramooflax 紧接着 bios 之后运行，之后其可以将 native 的 os 放到虚拟机中运行。
          <span class="footnote">[<a id="_footnoteref_1" class="footnote"
              href="https://github.com/airbus-seclab/ramooflax" title="">1</a>]</span>
          这启发我们，QEMU + unikernel 的制作可以采取类似的运行流程，只是需要将 intel vmx 加速的虚拟化替换为二进制翻译器即可。<br>而且，host 将设备完全交给 guest 管理，证明了设备直通的可行性。
        </p>
      </section>

      <section>
        <h2>动机</h2>
        <p>Ramooflax</p>
        <img class="r-stretch" src="../../images/ramooflax.png">
        <p style="font-size:0.5em">
          在启动 host 的 bios 之后，然后启动 ramooflax，之后 ramooflax 可以将 native 的 os 放到虚拟机中运行。
          <span class="footnote">[<a id="_footnoteref_1" class="footnote"
              href="https://github.com/airbus-seclab/ramooflax" title="">1</a>]</span>
          这启发我们，QEMU + unikernel 的制作可以采取类似的运行流程，只是需要将 intel vmx 加速的虚拟化替换为二进制翻译器。而且，host 将设备完全交给 guest 管理，证明了设备直通的可行性。
        </p>
      </section>

      <section>
        <h2>动机</h2>
        <p>Transmeta</p>

        <img class="r-stretch" src="../../images/transmeta.png">

        <p style="font-size:0.5em">
          Transmeta 公司推出的 Crusoe VLIW 芯片，其利用 Code Morphing Software (CMS)
          将 X86 指令翻译为 VLIW 指令，并使用硬件加速 Speculation , Precise exceptions 和 MMIO 访问等。
          <span class="footnote">[<a id="_footnoteref_1" class="footnote" href="" title="">The Transmeta Code Morphing
              Software: Using Speculation, Recovery, and Adaptive Retranslation to Address Real-Life
              Challenges</a>]</span>
        </p>
      </section>
      <section>

        <h2>动机</h2>
        构建一个针对于 QEMU 的 unikernel
        <img class="r-stretch" src="../../images/qemu-in-unikernel.svg">
        <p>
          <li style="font-size:0.5em">构建一个 unikernel，其中只是运行 QEMU</li>
          <li style="font-size:0.5em">QEMU 运行在 kernel 态, 从而可以直接使用访问 TLB 来加速访存</li>
        </p>
      </section>

      <section>
        <h2>动机</h2>
        <p>unikernel: 只为一个进程服务的 guest os</p>
        <img class="fragment"
          src="https://raw.githubusercontent.com/cetic/unikernels/master/MEDIA/normal_application_stack.PNG">
        <img class="fragment"
          src="https://raw.githubusercontent.com/cetic/unikernels/master/MEDIA/unikernel_application_stack.PNG">
      </section>

      <section>
        <h2>动机</h2>
        <img class="r-stretch" src="../../images/qemu-loc.png">
        <p style="font-size:0.5em">QEMU 可以运行在各种操作系统上，支持 kvm tcg hvf xen 等 cpu 虚拟化方案，支持多种设备的模拟</p>
      </section>

      <section>
        <h2>动机</h2>
        <img class="r-stretch" src="../../images/LKM.svg">
        <p style="font-size:0.5em">Linux 内核很强大，但是对于系统态二进制翻译器而言，大多数功能不需要，其他的进程对于 QEMU 而言是只是干扰</p>
        <div class="paragraph" style="font-size:0.2em">
          <p>
            <span class="footnote">[<a id="_footnoteref_1" class="footnote"
                href="https://makelinux.github.io/kernel/map/" title="View footnote.">1</a>]</span>
            Linux Kernel Maps
          </p>
        </div>
      </section>

      <section>
        <h2>背景</h2>
        <p>Linux + QEMU 实现系统态翻译 : hamt 加速访存</p>
        <img class="r-stretch" src="../../images/hamt.svg">
        <p style="font-size:0.5em">利用 dune 可以将 QEMU 放到 guest 态, 从而 QEMU 可以直接访问 TLB 来加速访存</p>
      </section>

      <section>
        <h2>背景</h2>
        <p style="font-size:0.9em">Linux + QEMU 实现系统态翻译 : xqm 加速 cpu 虚拟化</p>
        <img class="r-stretch" src="../../images/tcg.svg">
        <p style="font-size:0.5em">为了实现多个架构之间互相翻译，QEMU 采用了 tcg ir, 但是这导致了翻译质量下降。<br>而 mips-x86-qemu 项目将 tcg 移除掉了。</p>
      </section>

      <section>
        <h2>背景</h2>
        <p>Linux + QEMU 实现系统态翻译的几个部分</p>
        <table class="r-stretch">
          <thead>
            <tr>
              <th>内容</th>
              <th>二进制翻译模拟方法</th>
              <th>kvm</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>CPU</td>
              <td>tcg 逐条指令翻译</td>
              <td>硬件加速, 相同架构指令直接执行</td>
            </tr>
            <tr>
              <td>内存</td>
              <td>softmmu</td>
              <td>two dimension paging</td>
            </tr>
            <tr>
              <td>设备 / 中断</td>
              <td>设备模拟 / virtio / <mark> VFIO</mark>
                <span class="footnote">[<a id="_footnoteref_1" class="footnote"
                    href="https://bugs.launchpad.net/qemu/+bug/1869006" title="View footnote.">3</a>]</span>
              </td>
              <td>设备模拟 / virtio / VFIO</td>
            </tr>
          </tbody>
        </table>
      </section>


      <section>
        <h2>背景</h2>
        <p> Linux + QEMU 实现系统态翻译</p>
        <img class="r-stretch" src="../../images/QEMU-ARCH.svg">

        <div class="paragraph" style="font-size:0.2em">
          <p> qemu code
            <span class="footnote">[<a id="_footnoteref_1" class="footnote"
                href="https://vmsplice.net/~stefan/qemu-code-overview.pdf" title="View footnote.">2</a>]</span>
          </p>
        </div>
      </section>

      <section>
        <h2>目的</h2>

        <section>
          <li>消灭指令集的差异</li>
        </section>

        <section>
          <li>LoongArch 架构高效运行其他架构操作系统</li>
        </section>

        <section>
          <li>加速 LoongArch 上 x86 客户机操作系统运行</li>
        </section>
      </section>

      <section>
        <h2 class="r-rstrech">进度</h2>
        <ul>
          <li style="color:#d48ca7"> 背景调查</li>
          <li style="color:#d48ca7"> 架构设计</li>
          <li style="color:#d48ca7"> QEMU 的代码搬运</li>
          <ul style="color:#d48ca7">
            <li>枚举出来依赖的外部库</li>
            <li>枚举出来需要重构的接口</li>
          </ul>
          <li>用户态测试 seabios 代码</li>
          <li>移除依赖的第三方库</li>
          <li>裸机测试 32bit x86 Linux</li>
          <li style="color:#dbb330">裸机测试 xp</li>
          <li style="color:#dbb330">移植 HAMT</li>
          <li style="color:#dbb330">64bit 支持</li>
          <li style="color:#dbb330">多核支持</li>
        </ul>
      </section>

      <section>
        <h2>设计</h2>
        <img class="fragment" src="../../images/obito.jpg">
      </section>

      <section>
        <h2>设计</h2>
        <img class="fragment" src="../../images/obito.jpg">
      </section>

      <section>
        <h2>裸金属二进制翻译器的设计与实现</h2>
        <!-- <img class="r-stretch" src="../../images/obito.jpg"> -->
        <ol>
          <li>目的</li>
          <li>背景</li>
          <li>动机</li>
          <li>设计</li>
          <li>进度</li>
        </ol>
      </section>
    </div>
  </div>

  <script src="../../reveal.js/dist/reveal.js"></script>
  <script>
    Reveal.initialize({

      // Display presentation control arrows
      controls: true,

      // Help the user learn the controls by providing hints, for example by
      // bouncing the down arrow when they first encounter a vertical slide
      controlsTutorial: true,

      // Determines where controls appear, "edges" or "bottom-right"
      controlsLayout: 'bottom-right',

      // Visibility rule for backwards navigation arrows; "faded", "hidden"
      // or "visible"
      controlsBackArrows: 'faded',

      // Display a presentation progress bar
      progress: true,

      // Display the page number of the current slide
      // - true:    Show slide number
      // - false:   Hide slide number
      //
      // Can optionally be set as a string that specifies the number formatting:
      // - "h.v":   Horizontal . vertical slide number (default)
      // - "h/v":   Horizontal / vertical slide number
      // - "c":   Flattened slide number
      // - "c/t":   Flattened slide number / total slides
      //
      // Alternatively, you can provide a function that returns the slide
      // number for the current slide. The function should take in a slide
      // object and return an array with one string [slideNumber] or
      // three strings [n1,delimiter,n2]. See #formatSlideNumber().
      slideNumber: false,

      // Can be used to limit the contexts in which the slide number appears
      // - "all":      Always show the slide number
      // - "print":    Only when printing to PDF
      // - "speaker":  Only in the speaker view
      showSlideNumber: 'all',

      // Use 1 based indexing for # links to match slide number (default is zero
      // based)
      hashOneBasedIndex: false,

      // Add the current slide number to the URL hash so that reloading the
      // page/copying the URL will return you to the same slide
      hash: false,

      // Flags if we should monitor the hash and change slides accordingly
      respondToHashChanges: true,

      // Push each slide change to the browser history.  Implies `hash: true`
      history: false,

      // Enable keyboard shortcuts for navigation
      keyboard: true,

      // Optional function that blocks keyboard events when retuning false
      //
      // If you set this to 'focused', we will only capture keyboard events
      // for embedded decks when they are in focus
      keyboardCondition: null,

      // Disables the default reveal.js slide layout (scaling and centering)
      // so that you can use custom CSS layout
      disableLayout: false,

      // Enable the slide overview mode
      overview: true,

      // Vertical centering of slides
      center: true,

      // Enables touch navigation on devices with touch input
      touch: true,

      // Loop the presentation
      loop: false,

      // Change the presentation direction to be RTL
      rtl: false,

      // Changes the behavior of our navigation directions.
      //
      // "default"
      // Left/right arrow keys step between horizontal slides, up/down
      // arrow keys step between vertical slides. Space key steps through
      // all slides (both horizontal and vertical).
      //
      // "linear"
      // Removes the up/down arrows. Left/right arrows step through all
      // slides (both horizontal and vertical).
      //
      // "grid"
      // When this is enabled, stepping left/right from a vertical stack
      // to an adjacent vertical stack will land you at the same vertical
      // index.
      //
      // Consider a deck with six slides ordered in two vertical stacks:
      // 1.1    2.1
      // 1.2    2.2
      // 1.3    2.3
      //
      // If you're on slide 1.3 and navigate right, you will normally move
      // from 1.3 -> 2.1. If "grid" is used, the same navigation takes you
      // from 1.3 -> 2.3.
      navigationMode: 'default',

      // Randomizes the order of slides each time the presentation loads
      shuffle: false,

      // Turns fragments on and off globally
      fragments: true,

      // Flags whether to include the current fragment in the URL,
      // so that reloading brings you to the same fragment position
      fragmentInURL: true,

      // Flags if the presentation is running in an embedded mode,
      // i.e. contained within a limited portion of the screen
      embedded: false,

      // Flags if we should show a help overlay when the question-mark
      // key is pressed
      help: true,

      // Flags if it should be possible to pause the presentation (blackout)
      pause: true,

      // Flags if speaker notes should be visible to all viewers
      showNotes: false,

      // Global override for autolaying embedded media (video/audio/iframe)
      // - null:   Media will only autoplay if data-autoplay is present
      // - true:   All media will autoplay, regardless of individual setting
      // - false:  No media will autoplay, regardless of individual setting
      autoPlayMedia: null,

      // Global override for preloading lazy-loaded iframes
      // - null:   Iframes with data-src AND data-preload will be loaded when within
      //           the viewDistance, iframes with only data-src will be loaded when visible
      // - true:   All iframes with data-src will be loaded when within the viewDistance
      // - false:  All iframes with data-src will be loaded only when visible
      preloadIframes: null,

      // Can be used to globally disable auto-animation
      autoAnimate: true,

      // Optionally provide a custom element matcher that will be
      // used to dictate which elements we can animate between.
      autoAnimateMatcher: null,

      // Default settings for our auto-animate transitions, can be
      // overridden per-slide or per-element via data arguments
      autoAnimateEasing: 'ease',
      autoAnimateDuration: 1.0,
      autoAnimateUnmatched: true,

      // CSS properties that can be auto-animated. Position & scale
      // is matched separately so there's no need to include styles
      // like top/right/bottom/left, width/height or margin.
      autoAnimateStyles: [
        'opacity',
        'color',
        'background-color',
        'padding',
        'font-size',
        'line-height',
        'letter-spacing',
        'border-width',
        'border-color',
        'border-radius',
        'outline',
        'outline-offset'
      ],

      // Controls automatic progression to the next slide
      // - 0:      Auto-sliding only happens if the data-autoslide HTML attribute
      //           is present on the current slide or fragment
      // - 1+:     All slides will progress automatically at the given interval
      // - false:  No auto-sliding, even if data-autoslide is present
      autoSlide: 0,

      // Stop auto-sliding after user input
      autoSlideStoppable: true,

      // Use this method for navigation when auto-sliding (defaults to navigateNext)
      autoSlideMethod: null,

      // Specify the average time in seconds that you think you will spend
      // presenting each slide. This is used to show a pacing timer in the
      // speaker view
      defaultTiming: null,

      // Enable slide navigation via mouse wheel
      mouseWheel: false,

      // Opens links in an iframe preview overlay
      // Add `data-preview-link` and `data-preview-link="false"` to customise each link
      // individually
      previewLinks: false,

      // Exposes the reveal.js API through window.postMessage
      postMessage: true,

      // Dispatches all reveal.js events to the parent window through postMessage
      postMessageEvents: false,

      // Focuses body when page changes visibility to ensure keyboard shortcuts work
      focusBodyOnPageVisibilityChange: true,

      // Transition style
      transition: 'convex', // none/fade/slide/convex/concave/zoom

      // Transition style for full page slide backgrounds
      backgroundTransition: 'fade', // none/fade/slide/convex/concave/zoom

      // Number of slides away from the current that are visible
      viewDistance: 1000,

      // Number of slides away from the current that are visible on mobile
      // devices. It is advisable to set this to a lower number than
      // viewDistance in order to save resources.
      mobileViewDistance: 2,

      // The display mode that will be used to show slides
      display: 'block',

      // Hide cursor if inactive
      hideInactiveCursor: true,

      // Time before the cursor is hidden (in ms)
      hideCursorTime: 5000
    });
  </script>
</body>

</html>
